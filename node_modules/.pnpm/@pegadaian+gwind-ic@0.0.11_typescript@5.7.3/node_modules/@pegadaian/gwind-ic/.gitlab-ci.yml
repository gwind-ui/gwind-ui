image: artifactory.pegadaian.co.id:8084/node:20.10.0-alpine

variables:
  DOCKER_AUTH_CONFIG: '{"auths": {"artifactory.pegadaian.co.id:5443": {"auth": "$DOCKER_AU_CONFIG"},"artifactory.pegadaian.co.id:8084": {"auth": "$DOCKER_AU_CONFIG"}}}'
  REGISTRY: artifactory.pegadaian.co.id:8084
  NPM_URL: https://artifactory.pegadaian.co.id/repository/npm-hosted-01/

stages:
  - install
  - build
  - deploy

before_script:
  - npm install -g pnpm

cache:
  paths:
    - node_modules/
    - .pnpm-store/

install dependencies:
  stage: install
  script:
    - pnpm install
  artifacts:
    paths:
      - node_modules/
    expire_in: 1h
  only:
    - master
    - tags

build package:
  stage: build
  script:
    - pnpm run build
  artifacts:
    name: "$CI_COMMIT_REF_SLUG"
    paths:
      - dist/
    expire_in: 1h
  only:
    - master
    - tags
  needs:
    - install dependencies

deploy:
  image: $REGISTRY/node:20.10.0-alpine
  stage: deploy
  script:
    - echo "registry=$NPM_REGISTRY_URL" > .npmrc
    - echo "//artifactory.pegadaian.co.id/repository/npm-hosted-01/:_auth=$NPM_AUTH_TOKEN" >> .npmrc
    - npm publish --userconfig .npmrc
  only:
    - master
    - tags